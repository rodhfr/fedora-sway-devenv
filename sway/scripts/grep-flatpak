#!/bin/bash

# Função para listar apenas Application IDs
list_ids() {
    flatpak list | awk '{for(i=2;i<=NF;i++){if($i ~ /\./){print $i; break}}}'
}

# Verifica argumento
if [ -z "$1" ]; then
    echo "Use: $0 <app_name>"
    exit 1
fi

ARG="$1"
echo "Grepping $ARG..."

# 1️⃣ Tenta grep direto
RESULTS=$(list_ids | grep -i "$ARG")

# 2️⃣ Se grep retornou mais de uma linha, abre fzf para selecionar
if [ -n "$RESULTS" ]; then
    COUNT=$(echo "$RESULTS" | wc -l)
    if [ "$COUNT" -gt 1 ]; then
        echo "Multiple matches found. Select one:"
        RESULT=$(echo "$RESULTS" | fzf --prompt="Select Flatpak app: ")
    else
        RESULT="$RESULTS"
    fi
fi

# 3️⃣ Se grep não encontrou nada, tenta fuzzy find
if [ -z "$RESULT" ]; then
    echo "No exact match found. Trying fuzzy find..."
    RESULT=$(list_ids | fzf --filter="$ARG" --prompt="Fuzzy find Flatpak app: ")
fi

# 4️⃣ Se fuzzy find também não retornou nada, abre lista completa
if [ -z "$RESULT" ]; then
    echo "No fuzzy match found. Opening full list..."
    RESULT=$(list_ids | fzf --prompt="Select Flatpak app from full list: ")
fi

# 5️⃣ Se nada for selecionado, aborta
if [ -z "$RESULT" ]; then
    echo "No app selected."
    exit 1
fi

# Copia para clipboard
echo "$RESULT" | wl-copy
echo "\"$RESULT\" copied to clipboard."

